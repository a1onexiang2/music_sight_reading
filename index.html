<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº”çº¿è°±è®°å¿†æŒ‘æˆ˜</title>
    <style>
        :root {
            --bg-color: #f0f4f8;
            --staff-bg: #ffffff;
            --text-color: #333;
            --accent-color: #4a90e2;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* é¡¶éƒ¨æ§åˆ¶æ  */
        header {
            padding: 15px 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            gap: 15px;
        }

        .header-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:active {
            opacity: 0.8;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        
        label {
            font-size: 14px;
            font-weight: 500;
        }

        .stats {
            display: flex;
            gap: 15px;
            font-weight: bold;
            font-size: 16px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .life-heart {
            color: var(--danger-color);
        }

        /* æ¸¸æˆä¸»åŒºåŸŸ */
        #game-container {
            flex: 1;
            position: relative;
            background-color: var(--staff-bg);
            width: 100%;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* åº•éƒ¨é”®ç›˜ */
        footer {
            padding: 5px 10px 3px;
            background: #f8f8f8;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
            gap: 0;
            bottom: 120px;
            padding-bottom: max(15px, env(safe-area-inset-bottom));
            position: relative;
            height: 170px; /* è®¾ç½®å›ºå®šé«˜åº¦ä»¥å®¹çº³é»‘é”® */
        }
        
        /* ç™½é”®å®¹å™¨ï¼Œç”¨äºå®šä½é»‘é”® */
        .key-container {
            flex: 1;
            max-width: 60px;
            min-width: 40px; /* ç¡®ä¿ç§»åŠ¨ç«¯æœ‰æœ€å°å®½åº¦ */
            display: flex;
            justify-content: center;
            position: relative;
            height: 100%;
        }

        /* ç™½é”®æ ·å¼ */
        .key-btn {
            flex: 1;
            max-width: 60px;
            min-width: 40px; /* ç§»åŠ¨ç«¯æœ€å°å®½åº¦ */
            height: 150px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 0 #ddd;
            transition: transform 0.1s, box-shadow 0.1s, background-color 0.1s;
            position: relative;
            z-index: 1;
            padding-bottom: 5px;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
        }

        .key-btn:active {
            transform: translateY(2px);
            box-shadow: none;
            background-color: #f0f0f0;
        }
        
        /* é»‘é”®æ ·å¼ */
        .key-btn.black-key {
            width: 50%; /* å®½åº¦ä¸ºç™½é”®çš„1/2 */
            height: 80px; /* é«˜åº¦ä¸ºç™½é”®150pxçš„2/5 = 60px */
            background-color: #222;
            color: white;
            border: none;
            border-radius: 0 0 5px 5px;
            position: absolute;
            z-index: 2;
            left: 100%; /* å®šä½åœ¨å½“å‰ç™½é”®å®¹å™¨çš„å³ä¾§è¾¹ç¼˜ */
            transform: translateX(-50%); /* å‘å·¦ç§»åŠ¨è‡ªèº«å®½åº¦çš„ä¸€åŠï¼Œå®ç°å±…ä¸­ */
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-size: 12px;
            justify-content: center;
            padding: 0;
            max-width: none;
        }
        
        .key-btn.black-key:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            background-color: #444;
        }
        


        .key-name {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-color);
        }

        .solfege {
            font-size: 12px;
            color: #888;
        }

        /* è¿å‡»æç¤º */
        #combo-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: var(--accent-color);
            opacity: 0;
            pointer-events: none;
            text-shadow: 2px 2px 0px white;
        }

        @keyframes pop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        .combo-anim {
            animation: pop 0.5s ease-out forwards;
        }

        /* é¾™é˜Ÿåˆ—æ•ˆæœ */
        #dino-queue {
            position: absolute;
            top: 10px;
            left: 65px; /* ç§»åŠ¨åˆ°äº”çº¿è°±è™šçº¿ (50px) å³ä¾§ï¼Œç•™ç‚¹ä½™é‡ */
            display: flex;
            flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
            gap: 5px;
            pointer-events: none;
            z-index: 100;
            padding-right: 15px; /* å³ä¾§ç•™ç‚¹é—´è· */
            width: calc(100% - 65px); /* å®½åº¦æ‰£é™¤å·¦ä¾§åç§» */
            box-sizing: border-box;
            justify-content: flex-start; /* é å·¦æ’åˆ— */
        }

        .dino-item {
            font-size: 50px;
            animation: dino-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            display: inline-block;
            line-height: 1;
        }

        @keyframes dino-pop {
            0% { transform: scale(0) rotate(-20deg); opacity: 0; }
            70% { transform: scale(1.3) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        /* ç»ƒä¹ æ¨¡å¼éšè— UI */
        .practice-mode-active #game-stats,
        .practice-mode-active #combo-display {
            display: none !important;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 600px) {
            header {
                font-size: 12px;
                padding: 10px;
            }
            .header-group {
                gap: 10px;
            }
            .header-group > * {
                margin: 5px 0;
            }
            button {
                padding: 8px 12px;
                font-size: 13px;
                min-height: 36px;
            }
            select {
                padding: 6px 8px;
                font-size: 13px;
            }
            .stats {
                font-size: 14px;
                gap: 8px;
            }
            #game-container {
                flex: 1;
                padding: 10px;
            }
            footer {
                height: 100px;
            }
            .key-btn {
                height: 90px;
            }
            .key-btn.black-key {
                height: 36px; /* ç§»åŠ¨ç«¯ç™½é”®é«˜åº¦90pxçš„2/5 = 36px */
                width: 50%; /* ä¿æŒä¸ç™½é”®å®½åº¦çš„50%æ¯”ä¾‹ */
                left: 100%; /* ä¿æŒç›¸åŒçš„å®šä½é€»è¾‘ */
                transform: translateX(-50%); /* ä¿æŒç›¸åŒçš„å±…ä¸­é€»è¾‘ */
            }
            .key-name {
                font-size: 14px;
            }
            .solfege {
                font-size: 10px;
            }
        }
        
        @media (max-width: 400px) {
            header {
                font-size: 11px;
                padding: 6px 8px;
            }
            button {
                padding: 6px 10px;
                font-size: 12px;
            }
            .key-btn {
                height: 80px;
            }
            .key-name {
                font-size: 12px;
            }
        }

        /* è‡ªå®šä¹‰éŸ³é˜¶é€‰æ‹©å¼¹çª—æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .modal .close-btn {
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
            color: #666;
        }

        .modal-body {
            padding: 20px;
        }

        .scale-groups {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .scale-group h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #555;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
        }

        .scale-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .octave-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            width: 100%;
        }
        
        .octave-row:last-child {
            margin-bottom: 0;
        }

        .scale-checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .scale-checkbox-item input[type="checkbox"] {
            margin: 0;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .confirm-btn {
            background-color: #4CAF50;
            color: white;
        }

        .confirm-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        /* æ¸¸æˆç»“æŸå¼¹çª—æ ·å¼ */
        .game-over-content {
            text-align: center;
            padding: 20px 0;
        }
        
        .game-over-content p {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
        }
        
        .final-score {
            font-size: 48px;
            font-weight: bold;
            color: #4CAF50;
            margin: 20px 0;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 600px) {
            .modal-content {
                width: 95%;
                max-height: 90vh;
            }

            .scale-checkboxes {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-group">
            <button id="start-btn">å¼€å§‹</button>
            <label>éš¾åº¦</label>
            <select id="difficulty">
                <option value="easy">ç®€å•</option>
                <option value="medium" selected>ä¸­ç­‰</option>
                <option value="hard">å›°éš¾</option>
            </select>
            <label>éŸ³åŒº</label>
            <select id="note-area">
                <option value="treble" selected>é«˜</option>
                <option value="bass">ä½</option>
                <option value="both">é«˜ä½</option>
                <option value="custom">è‡ªå®šä¹‰</option>
            </select>
            <label>
                <input type="checkbox" id="hint-toggle"><label>éŸ³å</label>
            </label>
            <label>
                <input type="checkbox" id="note-numbers-toggle" disabled><label>éŸ³é˜¶</label>
            </label>
            <label>
                <input type="checkbox" id="color-mode-toggle"><label>å½©è‰²</label>
            </label>
            <label>
                <input type="checkbox" id="practice-mode-toggle"><label>ç»ƒä¹ </label>
            </label>
        </div>
        <div class="stats" id="game-stats">
            <div class="stat-item">åˆ†æ•°<span id="score">0</span></div>
            <div class="stat-item">ç”Ÿå‘½<span id="lives">â™¥â™¥â™¥</span></div>
        </div>
    </header>

    <!-- è‡ªå®šä¹‰éŸ³é˜¶é€‰æ‹©å¼¹çª— -->
    <div id="custom-scale-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>è‡ªå®šä¹‰éŸ³é˜¶é€‰æ‹©</h2>
                <button id="close-modal-btn" class="close-btn">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="scale-groups">
                    <div class="scale-group">
                        <h3>é«˜éŸ³åŒº (B3 - A5)</h3>
                        <div class="scale-checkboxes" id="treble-scales">
                            <!-- é«˜éŸ³åŒºéŸ³é˜¶å¤é€‰æ¡†å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="scale-group">
                        <h3>ä½éŸ³åŒº (E2 - A3)</h3>
                        <div class="scale-checkboxes" id="bass-scales">
                            <!-- ä½éŸ³åŒºéŸ³é˜¶å¤é€‰æ¡†å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-scale-btn" class="btn confirm-btn" disabled>ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
    <div id="game-over-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ¸¸æˆç»“æŸ</h2>
                <button id="close-game-over-btn" class="close-btn">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="game-over-content">
                    <p>æœ€ç»ˆå¾—åˆ†:</p>
                    <div id="final-score" class="final-score"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="combo-display">Combo!</div>
        <div id="dino-queue"></div>
    </div>

    <footer>
        <!-- ç™½é”®å®¹å™¨ï¼Œæ¯ä¸ªå®¹å™¨åŒ…å«ä¸€ä¸ªç™½é”®å’Œå¯èƒ½çš„é»‘é”® -->
        <div class="key-container">
            <!-- C ç™½é”® -->
            <button class="key-btn" data-note="C">
                <span class="key-name">C</span>
                <span class="solfege">do</span>
            </button>
            
            <!-- CD é»‘é”® - ä½äº C ç™½é”®çš„å³ä¾§ -->
            <button class="key-btn black-key" data-note="C#">
            </button>
        </div>
        
        <div class="key-container">
            <!-- D ç™½é”® -->
            <button class="key-btn" data-note="D">
                <span class="key-name">D</span>
                <span class="solfege">re</span>
            </button>
            
            <!-- DE é»‘é”® - ä½äº D ç™½é”®çš„å³ä¾§ -->
            <button class="key-btn black-key" data-note="D#">
            </button>
        </div>
        
        <div class="key-container">
            <!-- E ç™½é”® -->
            <button class="key-btn" data-note="E">
                <span class="key-name">E</span>
                <span class="solfege">mi</span>
            </button>
            <!-- æ— é»‘é”® -->
        </div>
        
        <div class="key-container">
            <!-- F ç™½é”® -->
            <button class="key-btn" data-note="F">
                <span class="key-name">F</span>
                <span class="solfege">fa</span>
            </button>
            
            <!-- FG é»‘é”® - ä½äº F ç™½é”®çš„å³ä¾§ -->
            <button class="key-btn black-key" data-note="F#">
            </button>
        </div>
        
        <div class="key-container">
            <!-- G ç™½é”® -->
            <button class="key-btn" data-note="G">
                <span class="key-name">G</span>
                <span class="solfege">so</span>
            </button>
            
            <!-- GA é»‘é”® - ä½äº G ç™½é”®çš„å³ä¾§ -->
            <button class="key-btn black-key" data-note="G#">
            </button>
        </div>
        
        <div class="key-container">
            <!-- A ç™½é”® -->
            <button class="key-btn" data-note="A">
                <span class="key-name">A</span>
                <span class="solfege">la</span>
            </button>
            
            <!-- AB é»‘é”® - ä½äº A ç™½é”®çš„å³ä¾§ -->
            <button class="key-btn black-key" data-note="A#">
            </button>
        </div>
        
        <div class="key-container">
            <!-- B ç™½é”® -->
            <button class="key-btn" data-note="B">
                <span class="key-name">B</span>
                <span class="solfege">si</span>
            </button>
            <!-- æ— é»‘é”® -->
        </div>
    </footer>

    <script>
        // === é…ç½® ===
        const CONFIG = {
            difficulties: {
                easy: { 
                    duration: { min: 9000, max: 12000 }, // éŸ³ç¬¦ç©¿è¿‡å±å¹•çš„æ—¶é•¿èŒƒå›´ï¼ˆæ¯«ç§’ï¼‰
                    spawnInterval: 3000 // 3ç§’å‡º1ä¸ª
                },
                medium: { 
                    duration: { min: 7000, max: 9000 },
                    spawnInterval: 2300 // 2.3ç§’å‡º1ä¸ª
                },
                hard: { 
                    duration: { min: 5000, max: 7000 },
                    spawnInterval: 1500 // 1.5ç§’å‡º1ä¸ª
                }
            },
            staffLineSpacing: 14, // äº”çº¿è°±çº¿é—´è·
            staffGap: 84,        // ä¸Šä¸‹è°±è¡¨é—´è·ï¼Œè°ƒæ•´ä¸ºæœ‰è¶³å¤Ÿç©ºé—´å®¹çº³ä¸­é—´çš„éŸ³ç¬¦
            noteRadius: 7         // éŸ³ç¬¦åŠå¾„
        };

        // === éŸ³æ•ˆç³»ç»Ÿ ===
        let audioContext;
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        function playNote(frequency, duration = 600) {
            if (!audioContext) {
                initAudio();
            }
            
            // æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœè¢«æš‚åœï¼‰
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = 'sine';
            oscillator.frequency.value = frequency;
            
            // è®¾ç½®éŸ³é‡åŒ…ç»œ
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }
        
        // éŸ³ç¬¦é¢‘ç‡æ˜ å°„ï¼ˆåŸºäºåäºŒå¹³å‡å¾‹ï¼ŒA4 = 440Hzï¼‰
        const NOTE_FREQUENCIES = {
            'C0': 16.35, 'C#0': 17.32, 'Db0': 17.32, 'D0': 18.35, 'D#0': 19.45, 'Eb0': 19.45, 'E0': 20.60, 'F0': 21.83, 'F#0': 23.12, 'Gb0': 23.12, 'G0': 24.50, 'G#0': 25.96, 'Ab0': 25.96, 'A0': 27.50, 'A#0': 29.14, 'Bb0': 29.14, 'B0': 30.87,
            'C1': 32.70, 'C#1': 34.65, 'Db1': 34.65, 'D1': 36.71, 'D#1': 38.89, 'Eb1': 38.89, 'E1': 41.20, 'F1': 43.65, 'F#1': 46.25, 'Gb1': 46.25, 'G1': 49.00, 'G#1': 51.91, 'Ab1': 51.91, 'A1': 55.00, 'A#1': 58.27, 'Bb1': 58.27, 'B1': 61.74,
            'C2': 65.41, 'C#2': 69.30, 'Db2': 69.30, 'D2': 73.42, 'D#2': 77.78, 'Eb2': 77.78, 'E2': 82.41, 'F2': 87.31, 'F#2': 92.50, 'Gb2': 92.50, 'G2': 98.00, 'G#2': 103.83, 'Ab2': 103.83, 'A2': 110.00, 'A#2': 116.54, 'Bb2': 116.54, 'B2': 123.47,
            'C3': 130.81, 'C#3': 138.59, 'Db3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'Eb3': 155.56, 'E3': 164.81, 'F3': 174.61, 'F#3': 185.00, 'Gb3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'Ab3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'Bb3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'C#4': 277.18, 'Db4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'Eb4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'Gb4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'Ab4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'Bb4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'Db5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'Eb5': 622.25, 'E5': 659.25, 'F5': 698.46, 'F#5': 739.99, 'Gb5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'Ab5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'Bb5': 932.33, 'B5': 987.77,
            'C6': 1046.50, 'C#6': 1108.73, 'Db6': 1108.73, 'D6': 1174.66, 'D#6': 1244.51, 'Eb6': 1244.51, 'E6': 1318.51, 'F6': 1396.91, 'F#6': 1479.98, 'Gb6': 1479.98, 'G6': 1567.98, 'G#6': 1661.22, 'Ab6': 1661.22, 'A6': 1760.00, 'A#6': 1864.66, 'Bb6': 1864.66, 'B6': 1975.53,
            'C7': 2093.00, 'C#7': 2217.46, 'Db7': 2217.46, 'D7': 2349.32, 'D#7': 2489.02, 'Eb7': 2489.02, 'E7': 2637.02, 'F7': 2793.83, 'F#7': 2959.96, 'Gb7': 2959.96, 'G7': 3135.96, 'G#7': 3322.44, 'Ab7': 3322.44, 'A7': 3520.00, 'A#7': 3729.31, 'Bb7': 3729.31, 'B7': 3951.07,
            'C8': 4186.01, 'C#8': 4434.92, 'Db8': 4434.92, 'D8': 4698.64, 'D#8': 4978.03, 'Eb8': 4978.03
        };

        // === çŠ¶æ€ç®¡ç† ===
        const state = {
            isPlaying: false,
            score: 0,
            lives: 3,
            combo: 0,
            notes: [], // å±å¹•ä¸Šçš„éŸ³ç¬¦
            explosions: [], // çˆ†ç‚¸æ•ˆæœ
            disappearances: [], // æ¶ˆå¤±åŠ¨ç”»
            lastSpawnTime: 0,
            difficulty: 'medium',
            showHints: false,
            showNoteNumbers: false, // æ˜¾ç¤ºéŸ³åæ•°å­—ï¼ˆå¦‚ C4ã€D4ï¼‰
            colorMode: false, // å½©è‰²æ¨¡å¼
            noteArea: 'treble', // 'treble' é«˜éŸ³åŒº, 'bass' ä½éŸ³åŒº, 'both' éƒ½å‡º, 'custom' è‡ªå®šä¹‰
            selectedScales: [], // è‡ªå®šä¹‰æ¨¡å¼ä¸‹é€‰ä¸­çš„éŸ³é˜¶
            isCustomMode: false, // æ˜¯å¦ä¸ºè‡ªå®šä¹‰æ¨¡å¼
            animationId: null,
            lastFrameTime: 0, // ç”¨äºè®¡ç®—å¸§ç‡
            inputLockedUntil: 0, // è¾“å…¥é”å®šæ—¶é—´æˆ³ï¼ˆ0è¡¨ç¤ºæœªé”å®šï¼‰
            eliminatedNotes: 0, // æ¶ˆé™¤çš„éŸ³ç¬¦æ•°é‡
            practiceEliminations: 0, // ç»ƒä¹ æ¨¡å¼ä¸‹çš„æ¶ˆé™¤è®¡æ•°
            dinoQueue: [], // ç»ƒä¹ æ¨¡å¼ä¸‹çš„é¾™é˜Ÿåˆ—
            isPracticeMode: false, // æ˜¯å¦ä¸ºç»ƒä¹ æ¨¡å¼
            speedLevel: 0, // é€Ÿåº¦ç­‰çº§
            speedIncreaseThreshold: 10 // æ¯æ¶ˆé™¤10ä¸ªéŸ³ç¬¦æå‡ä¸€æ¬¡é€Ÿåº¦
        };

        // === DOM å…ƒç´  ===
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('start-btn');
        const scoreEl = document.getElementById('score');
        const livesEl = document.getElementById('lives');
        const gameStatsEl = document.getElementById('game-stats');
        const difficultySelect = document.getElementById('difficulty');
        const hintToggle = document.getElementById('hint-toggle');
        const noteAreaSelect = document.getElementById('note-area');
        const noteNumbersToggle = document.getElementById('note-numbers-toggle');
        const colorModeToggle = document.getElementById('color-mode-toggle');
        const practiceModeToggle = document.getElementById('practice-mode-toggle');
        const comboDisplay = document.getElementById('combo-display');
        const dinoQueueEl = document.getElementById('dino-queue');
        const keys = document.querySelectorAll('.key-btn');

        // æé¾™ç›¸å…³ Emoji åˆ—è¡¨ï¼ˆç¡®ä¿æ˜¯æé¾™æˆ–ç›¸å…³å…ƒç´ ï¼‰
        const DINO_EMOJIS = [
            'ğŸ¦–', 'ğŸ¦•', 'ğŸ¢', 'ğŸ§‘â€ğŸš€', 'ğŸš€', 'ğŸª', 'ğŸ›¸', 'ğŸŒˆ', 'ğŸˆ', 'ğŸ­', 
            'ğŸ›°ï¸', 'ğŸ“¡', 'ğŸ”­', 'âœ¨', 'â˜„ï¸', 'âœˆï¸', 'ğŸ›«', 'ğŸ›©ï¸', 'ğŸš', 'ğŸš¢', 
        ];
        
        // è‡ªå®šä¹‰éŸ³é˜¶é€‰æ‹©å¼¹çª—å…ƒç´ 
        const customScaleModal = document.getElementById('custom-scale-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const confirmScaleBtn = document.getElementById('confirm-scale-btn');
        const bassScalesContainer = document.getElementById('bass-scales');
        const trebleScalesContainer = document.getElementById('treble-scales');
        
        // æ¸¸æˆç»“æŸå¼¹çª—å…ƒç´ 
        const gameOverModal = document.getElementById('game-over-modal');
        const closeGameOverBtn = document.getElementById('close-game-over-btn');
        const finalScoreEl = document.getElementById('final-score');

        // === åŠ¨ç”»ç±» ===
        class Explosion {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.radius = 0;
                this.maxRadius = 30;
                this.life = 1.0;
                this.particles = [];
                
                // åˆ›å»ºç²’å­
                for (let i = 0; i < 8; i++) {
                    const angle = (Math.PI * 2 * i) / 8;
                    this.particles.push({
                        x: this.x,
                        y: this.y,
                        vx: Math.cos(angle) * (Math.random() * 3 + 2),
                        vy: Math.sin(angle) * (Math.random() * 3 + 2),
                        life: 1.0
                    });
                }
            }
            
            update(deltaTime) {
                // åŸºäºæ—¶é—´çš„æ›´æ–°ï¼Œä½¿ç”¨æ ‡å‡†åŒ–çš„æ—¶é—´æ¯”ä¾‹ï¼ˆå‡è®¾60fpsä¸ºæ ‡å‡†ï¼‰
                const timeScale = deltaTime / 16.67;
                this.life -= 0.05 * timeScale;
                this.radius = this.maxRadius * (1 - this.life);
                
                // æ›´æ–°ç²’å­
                this.particles.forEach(particle => {
                    particle.life -= 0.08 * timeScale;
                    particle.x += particle.vx * timeScale;
                    particle.y += particle.vy * timeScale;
                });
            }
            
            draw(ctx) {
                const alpha = Math.max(0, this.life);
                
                // ç»˜åˆ¶ç²’å­
                this.particles.forEach(particle => {
                    const particleAlpha = particle.life;
                    ctx.fillStyle = `rgba(255, 255, 255, ${particleAlpha * 0.8})`;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, 2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = `rgba(231, 76, 60, ${particleAlpha * 0.6})`;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, 1, 0, Math.PI * 2);
                    ctx.fill();
                });
                
                // ç»˜åˆ¶å¤–åœˆ
                ctx.strokeStyle = `rgba(231, 76, 60, ${alpha})`;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
        
        class Disappearance {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.radius = CONFIG.noteRadius;
                this.life = 1.0;
                this.scale = 1.0;
            }
            
            update(deltaTime) {
                // åŸºäºæ—¶é—´çš„æ›´æ–°ï¼Œä½¿ç”¨æ ‡å‡†åŒ–çš„æ—¶é—´æ¯”ä¾‹ï¼ˆå‡è®¾60fpsä¸ºæ ‡å‡†ï¼‰
                const timeScale = deltaTime / 16.67;
                this.life -= 0.06 * timeScale; // å‡æ…¢æ¶ˆå¤±é€Ÿåº¦
                this.scale = 1.0 + (1 - this.life) * 2;
            }
            
            draw(ctx) {
                const alpha = Math.max(0, this.life);
                
                ctx.fillStyle = `rgba(74, 144, 226, ${alpha * 0.6})`;
                ctx.globalCompositeOperation = 'screen';
                
                // ç»˜åˆ¶ç¼©æ”¾çš„åœ†
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius * this.scale, 0, Math.PI * 2);
                ctx.fill();
                
                // ç»˜åˆ¶ä¸­å¿ƒäº®ç‚¹
                ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius * 0.3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.globalCompositeOperation = 'source-over';
            }
        }
        
        function createExplosion(x, y, color) {
            state.explosions.push(new Explosion(x, y, color));
        }
        
        function createDisappearance(x, y, color) {
            state.disappearances.push(new Disappearance(x, y, color));
        }
        
        // === å·¥å…·å‡½æ•° ===
        function getRandomSaturatedColor() {
            // ç”Ÿæˆéšæœºä½†é¥±å’Œçš„é¢œè‰²ï¼Œç¡®ä¿ä¸ä¼šä¸äº”çº¿è°±æ··æ·†
            // é¿å¼€é»„è‰² (45-75) å’Œç°è‰² (é¥±å’Œåº¦è¿‡ä½)
            let hue;
            do {
                hue = Math.floor(Math.random() * 360);
            } while (hue >= 45 && hue <= 75); // é¿å¼€é»„è‰²åŒºé—´
            
            return `hsl(${hue}, 80%, 45%)`; // æé«˜é¥±å’Œåº¦ï¼Œç•¥å¾®é™ä½äº®åº¦
        }

        // === æ¸¸æˆé€»è¾‘ç±» ===
        class Note {
            constructor(clef, noteData, speedPerMs) {
                this.clef = clef; // 'treble' or 'bass'
                this.name = noteData.name;
                this.fullName = noteData.fullName; // å®Œæ•´çš„éŸ³åï¼ŒåŒ…å«å…«åº¦ä¿¡æ¯
                this.offset = noteData.offset; // offset from Middle C
                this.reverse = noteData.reverse || false; // æ˜¯å¦åè½¬ï¼Œé»˜è®¤false
                this.x = canvas.width + 50;
                this.speedPerMs = speedPerMs; // é€Ÿåº¦ï¼šåƒç´ /æ¯«ç§’
                this.id = Math.random().toString(36).substr(2, 9);
                this.eliminated = false;
                this.color = getRandomSaturatedColor(); // ç”Ÿæˆéšæœºé¥±å’Œé¢œè‰²
            }

            update(deltaTime) {
                this.x -= this.speedPerMs * deltaTime;
            }

            draw(ctx, staffCenterY) {
                // è®¡ç®—Yåæ ‡
                // æ¯ä¸€çº§ offset å¯¹åº”åŠä¸ªé—´è·çš„é«˜åº¦å˜åŒ–
                // é«˜éŸ³è°±å· Middle C (offset 0) åœ¨ staffCenterY + 5 * spacing (å‡è®¾ staffCenterY æ˜¯è°±è¡¨ä¸­å¿ƒ B4? ä¸ï¼Œæˆ‘ä»¬è¦å®šé”šç‚¹)
                
                // è®©æˆ‘ä»¬å®šä¹‰ staffCenterY ä¸ºè¯¥è°±è¡¨çš„ "ä¸­å¿ƒçº¿" ä½ç½®
                // é«˜éŸ³è°±è¡¨ä¸­å¿ƒçº¿æ˜¯ B4 (Offset 6). 
                // ä½éŸ³è°±è¡¨ä¸­å¿ƒçº¿æ˜¯ D3 (Offset -6).
                
                let centerOffset = (this.clef === 'treble') ? 6 : -6;
                let stepsFromCenter = this.offset - centerOffset;
                
                // Yè½´å‘ä¸‹æ˜¯å¢åŠ ï¼ŒéŸ³é«˜å‘ä¸Šæ˜¯å¢åŠ ï¼Œæ‰€ä»¥æ˜¯å‡å»
                let y = staffCenterY - (stepsFromCenter * (CONFIG.staffLineSpacing / 2));
                
                this.y = y; // Save for debugging or strict collision if needed

                // é€‰æ‹©é¢œè‰²ï¼šå½©è‰²æ¨¡å¼ä¸‹ä½¿ç”¨éšæœºé¢œè‰²ï¼Œå¦åˆ™ä½¿ç”¨é»‘è‰²
                const noteColor = state.colorMode ? this.color : '#000000';

                // ç»˜åˆ¶éŸ³ç¬¦å¤´ (å®å¿ƒæ¤­åœ†)
                ctx.fillStyle = noteColor;
                ctx.beginPath();
                // æ ¹æ® reverse å±æ€§å†³å®šæ—‹è½¬è§’åº¦
                let rotationAngle = -0.2 + (this.reverse ? Math.PI : 0);
                ctx.ellipse(this.x, y, CONFIG.noteRadius + 1, CONFIG.noteRadius - 1, rotationAngle, 0, 2 * Math.PI);
                ctx.fill();
                ctx.fillStyle = 'black'; // æ¢å¤é»˜è®¤é¢œè‰²

                // ç»˜åˆ¶ç¬¦å¹² (Stem)
                ctx.strokeStyle = noteColor;
                ctx.beginPath();
                ctx.lineWidth = 1.5;
                let stemHeight = 35;
                
                // æ ¹æ® reverse å±æ€§å†³å®šç¬¦å¹²æ–¹å‘
                // reverse ä¸º false æ—¶ï¼Œç¬¦å¹²å‘ä¸Šï¼›ä¸º true æ—¶ï¼Œç¬¦å¹²å‘ä¸‹ï¼ˆæ—‹è½¬ï¼‰
                let shouldDrawStemUp = !this.reverse;

                if (!shouldDrawStemUp) {
                    // Stem Down (Left side)
                    ctx.moveTo(this.x - CONFIG.noteRadius, y);
                    ctx.lineTo(this.x - CONFIG.noteRadius, y + stemHeight);
                } else {
                    // Stem Up (Right side)
                    ctx.moveTo(this.x + CONFIG.noteRadius, y);
                    ctx.lineTo(this.x + CONFIG.noteRadius, y - stemHeight);
                }
                ctx.stroke();
                ctx.strokeStyle = 'black'; // æ¢å¤é»˜è®¤é¢œè‰²

                // ç»˜åˆ¶åŠ çº¿ (Ledger Lines)
                // Treble Lines: E4(2) to F5(11). 
                // Bass Lines: G2(-10) to A3(-2).
                
                // ç®€å•ç®—æ³•ï¼šåˆ¤æ–­å½“å‰éŸ³é«˜æ˜¯å¦è¶…å‡ºäº†äº”çº¿è°±èŒƒå›´
                // Treble: range [2, 10] are on/between lines. < 2 needs lower lines. > 10 needs upper lines.
                // Bass: range [-10, -2] are on/between lines. < -10 needs lower. > -2 needs upper.
                
                let lineStep = CONFIG.staffLineSpacing;
                
                if (this.clef === 'treble') {
                    // Middle C (0) needs line at 0.
                    // A5 (12) needs line at 12.
                    if (this.offset <= 0) { // Middle C or lower
                     for (let i = 0; i >= this.offset; i -= 2) {
                         this.drawLedgerLine(ctx, staffCenterY - ((i - 6) * lineStep / 2));
                     }
                }
                if (this.offset >= 12) { // A5 or higher
                    for (let i = 12; i <= this.offset; i += 2) {
                        this.drawLedgerLine(ctx, staffCenterY - ((i - 6) * lineStep / 2));
                    }
                }
                } else {
                    // Bass
                    // Middle C (0) needs line at 0.
                    // Low E (-12) needs line at -12.
                    if (this.offset >= 0) { // Middle C or higher
                        for (let i = 0; i <= this.offset; i += 2) {
                            this.drawLedgerLine(ctx, staffCenterY - ((i - (-6)) * lineStep / 2));
                        }
                    }
                    if (this.offset <= -12) { // Low E or lower
                        for (let i = -12; i >= this.offset; i -= 2) {
                            this.drawLedgerLine(ctx, staffCenterY - ((i - (-6)) * lineStep / 2));
                        }
                    }
                }

                // ç»˜åˆ¶æç¤º - ä¸éŸ³ç¬¦åŒè‰²ä¸”æ›´å¤§
                if (state.showHints) {
                    ctx.fillStyle = noteColor; // ä¸éŸ³ç¬¦åŒè‰²
                    ctx.font = 'bold 18px Arial'; // å­—ä½“æ›´å¤§
                    ctx.textAlign = 'center';
                    
                    // æ ¹æ® reverse å±æ€§å†³å®šæ–‡å­—ä½ç½®
                    // reverse ä¸º false æ—¶ï¼Œæ–‡å­—åœ¨ä¸‹æ–¹ï¼›ä¸º true æ—¶ï¼Œæ–‡å­—åœ¨ä¸Šæ–¹
                    let textY = this.reverse ? y - 15 : y + 25;
                    
                    // æ ¹æ®çŠ¶æ€å†³å®šæ˜¾ç¤ºå†…å®¹
                    let displayText = this.name;
                    if (state.showNoteNumbers) {
                        // ç›´æ¥ä½¿ç”¨é¢„å®šä¹‰çš„å®Œæ•´éŸ³å
                        displayText = this.fullName;
                    }
                    
                    ctx.fillText(displayText, this.x, textY);
                    ctx.fillStyle = 'black'; // æ¢å¤é»˜è®¤é¢œè‰²
                }
            }

            drawLedgerLine(ctx, y) {
                // é€‰æ‹©é¢œè‰²ï¼šå½©è‰²æ¨¡å¼ä¸‹ä½¿ç”¨éšæœºé¢œè‰²ï¼Œå¦åˆ™ä½¿ç”¨é»‘è‰²
                const noteColor = state.colorMode ? this.color : '#000000';
                ctx.strokeStyle = noteColor; // åŠ çº¿ä¹Ÿä½¿ç”¨ç›¸åŒé¢œè‰²
                ctx.beginPath();
                ctx.moveTo(this.x - 12, y);
                ctx.lineTo(this.x + 12, y);
                ctx.lineWidth = 1;
                ctx.stroke();
                ctx.strokeStyle = 'black'; // æ¢å¤é»˜è®¤é¢œè‰²
            }
        }

        // === è‡ªå®šä¹‰éŸ³é˜¶é€‰æ‹©é€»è¾‘ ===
        
        // å®šä¹‰å®Œæ•´çš„éŸ³é˜¶åˆ—è¡¨ï¼ˆE2åˆ°A5ï¼‰
        const ALL_SCALES = {
            treble: [
                { name: 'B', offset: -1, fullName: 'B3', reverse: false },
                { name: 'C', offset: 0, fullName: 'C4', reverse: false },
                { name: 'D', offset: 1, fullName: 'D4', reverse: false },
                { name: 'E', offset: 2, fullName: 'E4', reverse: false },
                { name: 'F', offset: 3, fullName: 'F4', reverse: false },
                { name: 'G', offset: 4, fullName: 'G4', reverse: false },
                { name: 'A', offset: 5, fullName: 'A4', reverse: false },
                { name: 'B', offset: 6, fullName: 'B4', reverse: false },
                { name: 'C', offset: 7, fullName: 'C5', reverse: true },
                { name: 'D', offset: 8, fullName: 'D5', reverse: true },
                { name: 'E', offset: 9, fullName: 'E5', reverse: true },
                { name: 'F', offset: 10, fullName: 'F5', reverse: true },
                { name: 'G', offset: 11, fullName: 'G5', reverse: true },
                { name: 'A', offset: 12, fullName: 'A5', reverse: true }
            ],
            bass: [
                { name: 'E', offset: -12, fullName: 'E2', reverse: false },
                { name: 'F', offset: -11, fullName: 'F2', reverse: false },
                { name: 'G', offset: -10, fullName: 'G2', reverse: false },
                { name: 'A', offset: -9, fullName: 'A2', reverse: false },
                { name: 'B', offset: -8, fullName: 'B2', reverse: false },
                { name: 'C', offset: -7, fullName: 'C3', reverse: false },
                { name: 'D', offset: -6, fullName: 'D3', reverse: true },
                { name: 'E', offset: -5, fullName: 'E3', reverse: true },
                { name: 'F', offset: -4, fullName: 'F3', reverse: true },
                { name: 'G', offset: -3, fullName: 'G3', reverse: true },
                { name: 'A', offset: -2, fullName: 'A3', reverse: true },
                { name: 'B', offset: -1, fullName: 'B3', reverse: true },
                { name: 'C', offset: 0, fullName: 'C4', reverse: true },
                { name: 'D', offset: 1, fullName: 'D4', reverse: true },
            ]
        };
        
        // åŠ¨æ€ç”ŸæˆéŸ³é˜¶å¤é€‰æ¡†
        function generateScaleCheckboxes() {
            // æ¸…ç©ºç°æœ‰å†…å®¹
            bassScalesContainer.innerHTML = '';
            trebleScalesContainer.innerHTML = '';
            
            // æŒ‰å…«åº¦åˆ†ç»„ç”ŸæˆéŸ³é˜¶å¤é€‰æ¡†
            function generateScalesByOctave(scales, container) {
                // æŒ‰å…«åº¦åˆ†ç»„
                const octaveGroups = {};
                scales.forEach(scale => {
                    const octave = scale.fullName.charAt(1); // è·å–å…«åº¦æ•°å­—
                    if (!octaveGroups[octave]) {
                        octaveGroups[octave] = [];
                    }
                    octaveGroups[octave].push(scale);
                });
                
                // è·å–å…«åº¦é”®å¹¶æŒ‰ä»é«˜åˆ°ä½æ’åº
                const octaveKeys = Object.keys(octaveGroups).sort((a, b) => b - a);
                
                // ç”Ÿæˆæ¯ä¸ªå…«åº¦çš„è¡Œ
                octaveKeys.forEach(octave => {
                    const row = document.createElement('div');
                    row.className = 'octave-row';
                    
                    const title = document.createElement('div');
                    title.className = 'octave-title';
                    title.textContent = `${octave}å…«åº¦`;
                    row.appendChild(title);
                    
                    // å¯¹æ¯ä¸ªå…«åº¦å†…çš„éŸ³ç¬¦æŒ‰éŸ³é«˜ä»é«˜åˆ°ä½æ’åº
                    octaveGroups[octave].sort((a, b) => b.offset - a.offset);
                    
                    octaveGroups[octave].forEach(scale => {
                        // ä¸ºé«˜éŸ³å’Œä½éŸ³åŒºçš„ç›¸åŒéŸ³ç¬¦åˆ›å»ºä¸åŒçš„ID
                        const checkboxId = container.id === 'treble-scales' ? 
                            `scale-treble-${scale.fullName}` : 
                            `scale-bass-${scale.fullName}`;
                        
                        const checkboxItem = document.createElement('div');
                        checkboxItem.className = 'scale-checkbox-item';
                        checkboxItem.innerHTML = `
                            <input type="checkbox" id="${checkboxId}" data-fullname="${scale.fullName}" data-offset="${scale.offset}" data-reverse="${scale.reverse}" data-clef="${container.id === 'treble-scales' ? 'treble' : 'bass'}">
                            <label for="${checkboxId}">${scale.fullName}</label>
                        `;
                        row.appendChild(checkboxItem);
                    });
                    
                    container.appendChild(row);
                });
            }
            
            // ç”Ÿæˆé«˜éŸ³åŒºéŸ³é˜¶å¤é€‰æ¡†ï¼ˆå…ˆæ’é«˜éŸ³ï¼‰
            generateScalesByOctave(ALL_SCALES.treble, trebleScalesContainer);
            
            // ç”Ÿæˆä½éŸ³åŒºéŸ³é˜¶å¤é€‰æ¡†
            generateScalesByOctave(ALL_SCALES.bass, bassScalesContainer);
            
            // æ·»åŠ å¤é€‰æ¡†å˜åŒ–äº‹ä»¶ç›‘å¬å™¨
            const allCheckboxes = document.querySelectorAll('.scale-checkbox-item input[type="checkbox"]');
            allCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateConfirmButtonState);
            });
        }
        
        // æ›´æ–°ç¡®å®šæŒ‰é’®çŠ¶æ€
        function updateConfirmButtonState() {
            const checkedCheckboxes = document.querySelectorAll('.scale-checkbox-item input[type="checkbox"]:checked');
            confirmScaleBtn.disabled = checkedCheckboxes.length === 0;
        }
        
        // æ˜¾ç¤ºå¼¹çª—
        function showCustomScaleModal() {
            generateScaleCheckboxes();
            customScaleModal.classList.add('show');
        }
        
        // éšè—å¼¹çª—
        function hideCustomScaleModal() {
            customScaleModal.classList.remove('show');
        }
        
        // ç¡®è®¤é€‰æ‹©
        function confirmCustomScales() {
            const checkedCheckboxes = document.querySelectorAll('.scale-checkbox-item input[type="checkbox"]:checked');
            const selectedScales = [];
            
            checkedCheckboxes.forEach(checkbox => {
                selectedScales.push({
                    fullName: checkbox.dataset.fullname,
                    offset: parseInt(checkbox.dataset.offset),
                    reverse: checkbox.dataset.reverse === 'true',
                    clef: checkbox.dataset.clef // ä¿å­˜è°±å·ä¿¡æ¯
                });
            });
            
            state.selectedScales = selectedScales;
            state.isCustomMode = true;
            
            // æ ¹æ®é€‰ä¸­çš„éŸ³é˜¶å†³å®šæ˜¾ç¤ºå“ªäº›è°±è¡¨
            const hasBassScales = selectedScales.some(scale => scale.clef === 'bass');
            const hasTrebleScales = selectedScales.some(scale => scale.clef === 'treble');
            
            if (hasBassScales && hasTrebleScales) {
                state.noteArea = 'both';
            } else if (hasBassScales) {
                state.noteArea = 'bass';
            } else if (hasTrebleScales) {
                state.noteArea = 'treble';
            } else {
                // æ²¡æœ‰é€‰ä¸­ä»»ä½•éŸ³é˜¶ï¼Œé»˜è®¤ä¸ºé«˜éŸ³åŒº
                state.noteArea = 'treble';
                state.isCustomMode = false;
            }
            
            hideCustomScaleModal();
        }
        
        // é€€å‡ºè‡ªå®šä¹‰æ¨¡å¼
        function exitCustomMode() {
            hideCustomScaleModal();
            noteAreaSelect.value = 'treble';
            state.noteArea = 'treble';
            state.isCustomMode = false;
            state.selectedScales = [];
        }
        
        // æ¸¸æˆç»“æŸå¼¹çª—é€»è¾‘
        function showGameOverModal(score) {
            finalScoreEl.textContent = score;
            gameOverModal.classList.add('show');
        }
        
        function hideGameOverModal() {
            gameOverModal.classList.remove('show');
        }

        // === æ ¸å¿ƒé€»è¾‘ ===

        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            startBtn.addEventListener('click', startGame);
            
            // ç»‘å®šé”®ç›˜/æŒ‰é’®äº‹ä»¶
            keys.forEach(btn => {
                const note = btn.dataset.note;
                // æ”¯æŒè§¦æ‘¸å’Œé¼ æ ‡ç‚¹å‡»
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault(); // é˜²æ­¢åŒå‡»ç¼©æ”¾å’Œæ»šåŠ¨
                    handleInput(note);
                    btn.classList.add('active'); // æ¨¡æ‹Ÿç‚¹å‡»æ•ˆæœ
                    setTimeout(() => btn.classList.remove('active'), 100);
                }, { passive: false }); // ç¡®ä¿preventDefaultç”Ÿæ•ˆ
                
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                }, { passive: false });
                
                btn.addEventListener('mousedown', (e) => {
                    handleInput(note);
                    btn.classList.add('active');
                });
                
                btn.addEventListener('mouseup', (e) => {
                    btn.classList.remove('active');
                });
            });

            // é”®ç›˜æ”¯æŒ (PC)
            window.addEventListener('keydown', (e) => {
                if (!state.isPlaying) return;
                const key = e.key.toUpperCase();
                if (['C','D','E','F','G','A','B'].includes(key)) {
                    // ç®€å•çš„è§†è§‰åé¦ˆ
                    const btn = document.querySelector(`button[data-note="${key}"]`);
                    if(btn) {
                        btn.style.backgroundColor = '#f0f0f0';
                        setTimeout(() => btn.style.backgroundColor = 'white', 100);
                    }
                    handleInput(key);
                }
            });

            difficultySelect.addEventListener('change', (e) => {
                state.difficulty = e.target.value;
            });

            hintToggle.addEventListener('change', (e) => {
                state.showHints = e.target.checked;
                // åªæœ‰å½“æ˜¾ç¤ºéŸ³åæ—¶ï¼Œæ‰èƒ½é€‰æ‹©æ˜¯å¦æ˜¾ç¤ºéŸ³åæ•°å­—
                noteNumbersToggle.disabled = !e.target.checked;
                if (!e.target.checked) {
                    noteNumbersToggle.checked = false;
                    state.showNoteNumbers = false;
                }
            });

            noteNumbersToggle.addEventListener('change', (e) => {
                state.showNoteNumbers = e.target.checked;
            });

            colorModeToggle.addEventListener('change', (e) => {
                state.colorMode = e.target.checked;
            });

            practiceModeToggle.addEventListener('change', (e) => {
                state.isPracticeMode = e.target.checked;
                if (state.isPracticeMode) {
                    document.body.classList.add('practice-mode-active');
                } else {
                    document.body.classList.remove('practice-mode-active');
                }
            });

            noteAreaSelect.addEventListener('change', (e) => {
                const selectedValue = e.target.value;
                if (selectedValue === 'custom') {
                    // æ˜¾ç¤ºè‡ªå®šä¹‰éŸ³é˜¶é€‰æ‹©å¼¹çª—
                    showCustomScaleModal();
                } else {
                    // éè‡ªå®šä¹‰æ¨¡å¼ï¼Œé‡ç½®çŠ¶æ€
                    state.noteArea = selectedValue;
                    state.isCustomMode = false;
                    state.selectedScales = [];
                }
            });
            
            // è‡ªå®šä¹‰éŸ³é˜¶é€‰æ‹©å¼¹çª—äº‹ä»¶ç›‘å¬å™¨
            closeModalBtn.addEventListener('click', exitCustomMode);
            confirmScaleBtn.addEventListener('click', confirmCustomScales);
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            customScaleModal.addEventListener('click', (e) => {
                if (e.target === customScaleModal) {
                    exitCustomMode();
                }
            });
            
            // æ¸¸æˆç»“æŸå¼¹çª—äº‹ä»¶ç›‘å¬å™¨
            closeGameOverBtn.addEventListener('click', hideGameOverModal);
            
            // ç§»é™¤ç‚¹å‡»æ¸¸æˆç»“æŸå¼¹çª—å¤–éƒ¨å…³é—­çš„åŠŸèƒ½ï¼Œåªå…è®¸ç‚¹å‡»xæŒ‰é’®å…³é—­
            // gameOverModal.addEventListener('click', (e) => {
            //     if (e.target === gameOverModal) {
            //         hideGameOverModal();
            //     }
            // });
        }

        function resizeCanvas() {
            const container = document.getElementById('game-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        function startGame() {
            if (state.isPlaying) return;
            
            state.isPlaying = true;
            state.score = 0;
            state.lives = 3;
            state.combo = 0;
            state.notes = [];
            state.lastSpawnTime = 0;
            state.eliminatedNotes = 0; // é‡ç½®æ¶ˆé™¤éŸ³ç¬¦è®¡æ•°å™¨
            state.practiceEliminations = 0; // é‡ç½®ç»ƒä¹ æ¨¡å¼æ¶ˆé™¤è®¡æ•°å™¨
            state.dinoQueue = []; // é‡ç½®é¾™é˜Ÿåˆ—
            dinoQueueEl.innerHTML = ''; // æ¸…ç©ºæ˜¾ç¤ºçš„é¾™
            state.speedLevel = 0; // é‡ç½®é€Ÿåº¦ç­‰çº§
            
            updateUI();
            startBtn.textContent = "æ¸¸æˆä¸­...";
            startBtn.disabled = true;
            difficultySelect.disabled = true;
            noteAreaSelect.disabled = true;

            requestAnimationFrame(gameLoop);
        }

        function gameOver() {
            state.isPlaying = false;
            startBtn.textContent = "é‡æ–°å¼€å§‹";
            startBtn.disabled = false;
            difficultySelect.disabled = false;
            noteAreaSelect.disabled = false;
            
            // ä½¿ç”¨è‡ªå®šä¹‰å¼¹çª—æ˜¾ç¤ºæ¸¸æˆç»“æŸä¿¡æ¯
            setTimeout(() => {
                showGameOverModal(state.score);
            }, 100);
        }

        function spawnNote() {
            const now = Date.now();
            const cfg = CONFIG.difficulties[state.difficulty];
            
            // æ ¹æ®é€Ÿåº¦ç­‰çº§è°ƒæ•´ç”Ÿæˆé€Ÿåº¦å’Œç§»åŠ¨é€Ÿåº¦
            // æ¯æ¬¡é€Ÿåº¦æå‡ï¼Œç”Ÿæˆé—´éš”å‡å°‘10%ï¼Œç§»åŠ¨é€Ÿåº¦å¢åŠ 10%
            const speedMultiplier = 1 - (state.speedLevel * 0.1);
            const adjustedSpawnInterval = cfg.spawnInterval * speedMultiplier;
            
            if (now - state.lastSpawnTime > adjustedSpawnInterval) {
                // æ ¹æ®é€‰æ‹©çš„åŒºåŸŸç”ŸæˆéŸ³ç¬¦
                let isTreble;
                let noteData;
                
                if (state.isCustomMode && state.selectedScales.length > 0) {
                    // è‡ªå®šä¹‰æ¨¡å¼ï¼šåªä»é€‰ä¸­çš„éŸ³é˜¶ä¸­ç”Ÿæˆ
                    const selectedScale = state.selectedScales[Math.floor(Math.random() * state.selectedScales.length)];
                    // ä½¿ç”¨ä¿å­˜çš„è°±å·ä¿¡æ¯
                    isTreble = selectedScale.clef === 'treble';
                    
                    // åˆ›å»ºéŸ³ç¬¦æ•°æ®å¯¹è±¡
                    noteData = {
                        name: selectedScale.fullName.charAt(0),
                        offset: selectedScale.offset,
                        fullName: selectedScale.fullName,
                        reverse: selectedScale.reverse
                    };
                } else {
                    // éè‡ªå®šä¹‰æ¨¡å¼ï¼šæŒ‰ç…§åŸæ¥çš„é€»è¾‘
                    if (state.noteArea === 'treble') {
                        isTreble = true;
                        const pool = ALL_SCALES.treble;
                        noteData = pool[Math.floor(Math.random() * pool.length)];
                    } else if (state.noteArea === 'bass') {
                        isTreble = false;
                        const pool = ALL_SCALES.bass;
                        noteData = pool[Math.floor(Math.random() * pool.length)];
                    } else {
                        // éƒ½å‡ºçš„æƒ…å†µä¸‹ï¼Œç¡®ä¿æ‰€æœ‰éŸ³ç¬¦å‡ºç°æ¦‚ç‡ç›¸ç­‰
                        // åˆå¹¶ä¸¤ä¸ªè°±è¡¨çš„éŸ³ç¬¦ï¼Œå»é‡ï¼ˆC4åªç®—ä¸€æ¬¡ï¼‰
                        const combinedNotes = [];
                        const noteMap = {};
                        
                        // æ·»åŠ é«˜éŸ³è°±å·çš„éŸ³ç¬¦
                        ALL_SCALES.treble.forEach(note => {
                            if (!noteMap[note.fullName]) {
                                noteMap[note.fullName] = true;
                                combinedNotes.push({...note, preferredClef: 'treble'});
                            }
                        });
                        
                        // æ·»åŠ ä½éŸ³è°±å·ä¸­é«˜éŸ³è°±å·æ²¡æœ‰çš„éŸ³ç¬¦
                        ALL_SCALES.bass.forEach(note => {
                            if (!noteMap[note.fullName]) {
                                noteMap[note.fullName] = true;
                                combinedNotes.push({...note, preferredClef: 'bass'});
                            }
                        });
                        
                        // éšæœºé€‰æ‹©ä¸€ä¸ªéŸ³ç¬¦
                        const selectedNote = combinedNotes[Math.floor(Math.random() * combinedNotes.length)];
                        noteData = selectedNote;
                        
                        // å¯¹äºB3ã€C4å’ŒD4ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªè°±å·
                        if (selectedNote.fullName === 'B3' || selectedNote.fullName === 'C4' || selectedNote.fullName === 'D4') {
                            isTreble = Math.random() > 0.5;
                        } else {
                            // å¯¹äºå…¶ä»–éŸ³ç¬¦ï¼Œä½¿ç”¨å…¶é¦–é€‰è°±å·
                            isTreble = selectedNote.preferredClef === 'treble';
                        }
                    }
                }
                
                // è®¡ç®—éŸ³ç¬¦ç§»åŠ¨é€Ÿåº¦ï¼šåŸºäºå±å¹•å®½åº¦å’Œå½“å‰éš¾åº¦çš„æ—¶é•¿èŒƒå›´
                const screenWidth = canvas.width;
                const durationRange = cfg.duration;
                // åœ¨æ—¶é•¿èŒƒå›´å†…éšæœºé€‰æ‹©ä¸€ä¸ªå€¼ï¼Œå¹¶æ ¹æ®é€Ÿåº¦ç­‰çº§è°ƒæ•´
                const baseDuration = durationRange.min + Math.random() * (durationRange.max - durationRange.min);
                const adjustedDuration = baseDuration * speedMultiplier;
                // è®¡ç®—é€Ÿåº¦ï¼šè·ç¦» / æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
                const speedPerMs = screenWidth / adjustedDuration;
                
                const note = new Note(
                    isTreble ? 'treble' : 'bass',
                    noteData,
                    speedPerMs
                );
                
                state.notes.push(note);
                state.lastSpawnTime = now;
            }
        }

        function handleInput(noteName) {
            if (!state.isPlaying) return;
            
            // æ£€æŸ¥æ˜¯å¦å¤„äºè¾“å…¥é”å®šçŠ¶æ€
            if (Date.now() < state.inputLockedUntil) {
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯é»‘é”®ï¼ˆå¸¦#çš„éŸ³ç¬¦ï¼‰ï¼Œé»‘é”®åªæ˜¾ç¤ºåŠ¨æ•ˆä¸å½±å“æ¸¸æˆé€»è¾‘
            if (noteName.includes('#')) {
                // åªæ˜¾ç¤ºç®€å•çš„åŠ¨æ•ˆï¼Œä¸å½±å“æ¸¸æˆé€»è¾‘
                return;
            }

            // è·å–æ‰€æœ‰æœªæ¶ˆé™¤çš„éŸ³ç¬¦ï¼ŒæŒ‰ä»å·¦åˆ°å³ï¼ˆXæœ€å°ï¼‰æ’åº
            const allActiveNotes = state.notes
                .filter(n => !n.eliminated)
                .sort((a, b) => a.x - b.x);

            if (allActiveNotes.length > 0) {
                // è·å–æœ€å·¦è¾¹çš„éŸ³ç¬¦
                const leftmostNote = allActiveNotes[0];
                
                if (leftmostNote.name === noteName) {
                    // æ­£ç¡®ï¼šæŒ‰é¡ºåºç‚¹å‡»äº†æœ€å·¦è¾¹çš„éŸ³ç¬¦
                    leftmostNote.eliminated = true;
                    
                    // è®¡ç®—åˆ†æ•°
                    let points = 10;
                    if (state.combo > 0) {
                        points += Math.min(state.combo, 10); // è¿å‡»åŠ åˆ†ï¼Œä¸Šé™+10 (å³å•æ¬¡æœ€å¤š20)
                    }
                    
                    state.score += points;
                    state.combo++;
                    state.eliminatedNotes++;
                    state.practiceEliminations++;
                    
                    if (state.isPracticeMode && state.practiceEliminations % 3 === 0) {
                        addDinosaur();
                    }
                    
                    showCombo();
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æå‡é€Ÿåº¦
                    if (state.eliminatedNotes % state.speedIncreaseThreshold === 0) {
                        state.speedLevel++;
                        showSpeedIncrease();
                    }
                    
                    // æ’­æ”¾éŸ³ç¬¦éŸ³æ•ˆ
                    const frequency = NOTE_FREQUENCIES[leftmostNote.fullName];
                    if (frequency) {
                        playNote(frequency);
                    }
                    
                    // åˆ›å»ºæ¶ˆå¤±åŠ¨ç”»
                createDisappearance(leftmostNote.x, leftmostNote.y, '#2980b9');
                
                // ç§»é™¤éŸ³ç¬¦
                state.notes = state.notes.filter(n => n !== leftmostNote);
            } else {
                    // é”™è¯¯ï¼šç‚¹å‡»äº†éæœ€å·¦è¾¹çš„éŸ³ç¬¦ï¼Œä¸­æ–­è¿å‡»
                    state.combo = 0;
                    
                    // è®¾ç½®è¾“å…¥é”å®šæƒ©ç½š
                    state.inputLockedUntil = Date.now() + 500; // é”å®š0.5ç§’
                    
                    // ä¸å†æ¶ˆé™¤å…¶ä»–åŒ¹é…çš„éŸ³ç¬¦ï¼Œåªä¸­æ–­è¿å‡»å¹¶è®¾ç½®æƒ©ç½š
                }
            } else {
                // å±å¹•ä¸Šæ²¡æœ‰éŸ³ç¬¦ï¼Œé”™è¯¯ç‚¹å‡»
                state.combo = 0;
                
                // è®¾ç½®è¾“å…¥é”å®šæƒ©ç½š
                state.inputLockedUntil = Date.now() + 500; // é”å®š0.5ç§’
            }
            updateUI();
        }

        function updateUI() {
            scoreEl.textContent = state.score;
            // æ˜¾ç¤ºç”Ÿå‘½å€¼ï¼šå®å¿ƒçˆ±å¿ƒè¡¨ç¤ºå‰©ä½™çš„ç”Ÿå‘½ï¼Œç©ºå¿ƒçˆ±å¿ƒè¡¨ç¤ºå¤±å»çš„ç”Ÿå‘½
            const maxLives = 3;
            const lostLives = maxLives - state.lives;
            livesEl.innerHTML = "â™¥".repeat(state.lives) + "â™¡".repeat(lostLives);
        }

        function showCombo() {
            if (state.combo > 1) {
                comboDisplay.textContent = `${state.combo} è¿å‡»!`;
                comboDisplay.classList.remove('combo-anim');
                void comboDisplay.offsetWidth; // trigger reflow
                comboDisplay.classList.add('combo-anim');
            }
        }

        function addDinosaur() {
            // è·å–æœ€è¿‘å‡ºè¿‡çš„ 5 ä¸ª Emoji
            const recentDinos = state.dinoQueue.slice(-5);
            
            // è¿‡æ»¤æ‰æœ€è¿‘å‡ºè¿‡çš„ Emojiï¼Œä»å‰©ä½™ä¸­éšæœºé€‰
            const availableDinos = DINO_EMOJIS.filter(dino => !recentDinos.includes(dino));
            
            // å¦‚æœåˆ—è¡¨é…ç½®å¾—å¤ªçŸ­å¯¼è‡´æ²¡å¯é€‰çš„ï¼ˆè™½ç„¶ç›®å‰æœ‰ 9 ä¸ªï¼‰ï¼Œå°±é€€è€Œæ±‚å…¶æ¬¡ç”¨å…¨éƒ¨
            const pool = availableDinos.length > 0 ? availableDinos : DINO_EMOJIS;
            const randomDino = pool[Math.floor(Math.random() * pool.length)];
            
            state.dinoQueue.push(randomDino);

            // æ›´æ–° UI
            const dinoItem = document.createElement('div');
            dinoItem.className = 'dino-item';
            dinoItem.textContent = randomDino;
            
            // éšæœºè½»å¾®æ—‹è½¬ï¼Œè®©æ’é˜Ÿçœ‹èµ·æ¥æ›´ç”ŸåŠ¨
            const randomRotation = (Math.random() - 0.5) * 20; // -10 åˆ° 10 åº¦
            dinoItem.style.transform = `rotate(${randomRotation}deg)`;
            
            dinoQueueEl.appendChild(dinoItem);
        }

        function showSpeedIncrease() {
            comboDisplay.textContent = `é€Ÿåº¦æå‡!`;
            comboDisplay.classList.remove('combo-anim');
            void comboDisplay.offsetWidth; // trigger reflow
            comboDisplay.classList.add('combo-anim');
        }

        function drawStaff(startY, clefType) {
            ctx.strokeStyle = '#aaa'; // äº”çº¿è°±å†ç°ä¸€ç‚¹
            ctx.lineWidth = 1;
            const spacing = CONFIG.staffLineSpacing;
            
            // ç»˜åˆ¶5æ¡çº¿
            // startY æ˜¯ä¸­å¿ƒçº¿çš„ä½ç½® (Line 3)
            // Line 1 (Bottom): startY + 2 * spacing
            // Line 5 (Top): startY - 2 * spacing
            
            const lineLength = canvas.width;
            
            for (let i = -2; i <= 2; i++) {
                let y = startY + (i * spacing);
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(lineLength, y);
                ctx.stroke();
            }

            // ç»˜åˆ¶è°±å·
            ctx.fillStyle = '#000000'; // è°±å·æ”¹ä¸ºé»‘è‰²
            ctx.textAlign = 'left';
            
            // è®¡ç®—äº”çº¿è°±çš„æ€»é«˜åº¦ï¼š5æ¡çº¿ï¼Œ4ä¸ªé—´ = 4ä¸ªçº¿é—´è·
            const staffHeight = 4 * CONFIG.staffLineSpacing;
            
            // è®¾ç½®ç›®æ ‡è°±å·é«˜åº¦ä¸ºäº”çº¿è°±é«˜åº¦çš„1.5å€ï¼ˆå¯ä»¥è°ƒæ•´è¿™ä¸ªæ¯”ä¾‹ï¼‰
            const targetClefHeight = staffHeight * 1.5;
            
            // é«˜éŸ³è°±å·å’Œä½éŸ³è°±å·åœ¨ç›¸åŒå­—ä½“å¤§å°ä¸‹è§†è§‰å°ºå¯¸ä¸åŒ
            // è¿™é‡Œä¸ºå®ƒä»¬è®¾ç½®ä¸åŒçš„ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿è§†è§‰å¤§å°ä¸€è‡´
            let fontSize;
            
            if (clefType === 'treble') {
                // é«˜éŸ³è°±å· ğ„ - éœ€è¦ç¨å°çš„å­—ä½“å¤§å°
                fontSize = Math.round(targetClefHeight * 0.8);
                ctx.font = `${fontSize}px serif`;
                ctx.fillText('ğ„', 8, startY + staffHeight / 2); 
            } else {
                // ä½éŸ³è°±å· ğ„¢ - éœ€è¦ç¨å¤§çš„å­—ä½“å¤§å°
                fontSize = Math.round(targetClefHeight * 0.8);
                ctx.font = `${fontSize}px serif`;
                ctx.fillText('ğ„¢', 8, startY + staffHeight / 2);
            }
        }

        function gameLoop(timestamp) {
            if (!state.isPlaying) return;
            
            // Calculate delta time
            const deltaTime = state.lastFrameTime ? timestamp - state.lastFrameTime : 16.67;
            state.lastFrameTime = timestamp;

            // Clear
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Calculate Staff Positions
            const centerY = canvas.height / 2;
            
            // æ ¹æ®é€‰æ‹©çš„åŒºåŸŸåŠ¨æ€è®¡ç®—è°±è¡¨ä½ç½®
            let trebleCenterY = centerY;
            let bassCenterY = centerY;
            
            if (state.noteArea === 'both') {
                // éƒ½å‡ºï¼šä¸¤ä¸ªè°±è¡¨éƒ½æ˜¾ç¤ºï¼Œä½ç½®åˆ†å¼€ï¼Œç¡®ä¿å®ƒä»¬çš„C4ä½ç½®é‡åˆ
                // ä½¿ç”¨CONFIG.staffGapæ¥æ§åˆ¶ä¸¤ä¸ªè°±è¡¨ä¹‹é—´çš„æ€»é—´è·
                const totalGap = CONFIG.staffGap;
                
                // è®¾ç½®ä¸¤ä¸ªè°±è¡¨çš„ä½ç½®ï¼Œä½¿å®ƒä»¬çš„C4åœ¨åŒä¸€å‚ç›´çº¿ä¸Š
                trebleCenterY = centerY - totalGap / 2;
                bassCenterY = centerY + totalGap / 2;
            } else if (state.noteArea === 'treble') {
                // åªå‡ºé«˜éŸ³åŒºï¼šé«˜éŸ³è°±è¡¨å±…ä¸­æ˜¾ç¤º
                trebleCenterY = centerY;
            } else { // åªå‡ºä½éŸ³åŒº
                // åªå‡ºä½éŸ³åŒºï¼šä½éŸ³è°±è¡¨å±…ä¸­æ˜¾ç¤º
                bassCenterY = centerY;
            }

            // Draw Staves based on selection
            if (state.noteArea === 'both' || state.noteArea === 'treble') {
                drawStaff(trebleCenterY, 'treble');
            }
            if (state.noteArea === 'both' || state.noteArea === 'bass') {
                drawStaff(bassCenterY, 'bass');
            }
            
            // Draw collision boundary (dashed line)
            ctx.strokeStyle = '#000000'; // ä¸è°±å·åŒè‰²ï¼ˆé»‘è‰²ï¼‰
            ctx.setLineDash([10, 5]); // è™šçº¿æ ·å¼ï¼š10åƒç´ å®çº¿ï¼Œ5åƒç´ ç©ºç™½
            ctx.lineWidth = 2;
            const boundaryX = 50; // ç¢°æ’è¾¹ç•Œä½ç½®
            ctx.beginPath();
            ctx.moveTo(boundaryX, 0);
            ctx.lineTo(boundaryX, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]); // é‡ç½®ä¸ºå®çº¿

            // Spawn
            spawnNote();

            // Update & Draw Notes
            for (let i = state.notes.length - 1; i >= 0; i--) {
                const note = state.notes[i];
                note.update(deltaTime);

                // åˆ¤å®šæ˜¯å¦æ¼æ‰ (åˆ°è¾¾å·¦è¾¹ç¼˜)
                if (note.x < 50) { // ä¹Ÿå°±æ˜¯è¶Šè¿‡äº†è°±å·åŒºåŸŸ
                    // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
                    createExplosion(note.x, note.y, '#e74c3c'); // çº¢è‰²çˆ†ç‚¸
                    
                    if (!state.isPracticeMode) {
                        state.lives--;
                        state.combo = 0;
                        updateUI();
                        
                        if (state.lives <= 0) {
                            gameOver();
                            return; // Stop loop
                        }
                    } else {
                        // ç»ƒä¹ æ¨¡å¼ä¸‹ï¼ŒéŸ³ç¬¦åˆ°åº•è™½ç„¶ä¼šçˆ†ç‚¸ä½†æ˜¯ä¸ä¼šæ‰£è¡€ï¼Œä¸ä¼šå¤±è´¥
                        state.combo = 0; // è™½ç„¶ä¸æ˜¾ç¤º comboï¼Œä½†å†…éƒ¨é€»è¾‘è¿˜æ˜¯é‡ç½®ä¸€ä¸‹æ¯”è¾ƒç¨³å¦¥
                    }
                    
                    state.notes.splice(i, 1);
                    continue;
                }

                // ç»˜åˆ¶éŸ³ç¬¦ï¼Œæ ¹æ®å½“å‰é€‰æ‹©çš„åŒºåŸŸä½¿ç”¨æ­£ç¡®çš„è°±è¡¨ä½ç½®
                let staffY;
                if (state.noteArea === 'both') {
                    // éƒ½å‡ºï¼šä½¿ç”¨å„è‡ªçš„è°±è¡¨ä½ç½®
                    staffY = (note.clef === 'treble') ? trebleCenterY : bassCenterY;
                } else if (state.noteArea === 'treble' && note.clef === 'treble') {
                    // åªå‡ºé«˜éŸ³åŒºï¼šä½¿ç”¨é«˜éŸ³è°±è¡¨å±…ä¸­ä½ç½®
                    staffY = trebleCenterY;
                } else if (state.noteArea === 'bass' && note.clef === 'bass') {
                    // åªå‡ºä½éŸ³åŒºï¼šä½¿ç”¨ä½éŸ³è°±è¡¨å±…ä¸­ä½ç½®
                    staffY = bassCenterY;
                } else {
                    // ä¸åº”è¯¥ç»˜åˆ¶çš„éŸ³ç¬¦ï¼ˆä¾‹å¦‚é€‰æ‹©é«˜éŸ³åŒºä½†éŸ³ç¬¦æ˜¯ä½éŸ³ï¼‰
                    continue;
                }
                
                note.draw(ctx, staffY);
            }
            
            // Update & Draw Explosions
            for (let i = state.explosions.length - 1; i >= 0; i--) {
                const explosion = state.explosions[i];
                explosion.update(deltaTime);
                explosion.draw(ctx);
                
                if (explosion.life <= 0) {
                    state.explosions.splice(i, 1);
                }
            }
            
            // Update & Draw Disappearances
            for (let i = state.disappearances.length - 1; i >= 0; i--) {
                const disappearance = state.disappearances[i];
                disappearance.update(deltaTime);
                disappearance.draw(ctx);
                
                if (disappearance.life <= 0) {
                    state.disappearances.splice(i, 1);
                }
            }

            requestAnimationFrame(gameLoop);
        }

        // å¯åŠ¨
        init();
        
        // åˆå§‹ç”»é¢åªè°ƒæ•´ç”»å¸ƒå¤§å°ï¼Œä¸ç»˜åˆ¶äº”çº¿è°±
        window.onload = () => {
             resizeCanvas();
        };

    </script>
</body>
</html>